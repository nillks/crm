# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º —Å Instagram (Chatrace)

## –ü—Ä–æ–±–ª–µ–º–∞: –°–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Instagram –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è

### –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

1. ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ polling –¥–ª—è Instagram
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–ª—è Chatrace API
3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

### –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

#### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –ª–æ–≥–∏:

```
Instagram Service initialized (CHATRACE API)
Chatrace API configured
üîß InstagramService onModuleInit called
üì° Starting Instagram message polling (Chatrace)...
‚úÖ Starting Instagram message polling (checking every 10 seconds)
üì° API URL: https://api.chatrace.com
üîç Starting Instagram message check...
üîç Checking for new Instagram messages: https://api.chatrace.com/messages/receive
```

#### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ .env

```bash
INSTAGRAM_API_URL=https://api.chatrace.com
INSTAGRAM_ACCESS_TOKEN=1543616.9NzKE301G8dmBBDxnJtACY1YXnDXFJ2HF
INSTAGRAM_USE_CHATRACE=true
INSTAGRAM_USE_MOCK=false
```

#### 3. –í–∞–∂–Ω–æ: Chatrace –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å polling!

**Chatrace, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ webhooks**, –∞ –Ω–µ polling (–∫–∞–∫ Green API –¥–ª—è WhatsApp).

### –†–µ—à–µ–Ω–∏–µ: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Webhook –≤ Chatrace

1. **–í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Chatrace:**
   - https://chatrace.com/en/settings?acc=1543616
   - https://chatrace.com/e

2. **–ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª "Webhooks" –∏–ª–∏ "API Settings"**

3. **–î–æ–±–∞–≤—å—Ç–µ webhook URL:**
   - –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok
     ```
     https://your-ngrok-url.ngrok.io/instagram/webhook
     ```
   - –î–ª—è production:
     ```
     https://your-domain.com/instagram/webhook
     ```

4. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ webhook –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω**

5. **–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è:**
   - "Instagram messages"
   - "Incoming messages"

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Webhook

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ Chatrace, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Instagram –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üì® Received webhook from Instagram/Chatrace
üìÖ Time: 2024-11-13T12:00:00.000Z
üì¶ Body type: object
üì¶ Body keys: senderId, messageId, text, ...
üì¶ Full body: { ... }
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîÑ Processing Chatrace webhook: { ... }
üìù Extracted data from Chatrace webhook:
  - senderId: ...
  - messageId: ...
  - text: ...
‚úÖ Chatrace Instagram message processed: ...
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ú–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å endpoint –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
curl -X GET http://localhost:3000/instagram/check-messages \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### –ï—Å–ª–∏ webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ:**
   - –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok
   - –î–ª—è production –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –¥–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞:**
   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook

3. **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É Chatrace:**
   - –£—Ç–æ—á–Ω–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç webhook'–æ–≤
   - –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ª–∏ polling
   - –£—Ç–æ—á–Ω–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é Chatrace

–ï—Å–ª–∏ Chatrace –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç webhooks –∏–ª–∏ polling, –≤–æ–∑–º–æ–∂–Ω–æ:
- –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π endpoint
- –ù—É–∂–µ–Ω –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –°–µ—Ä–≤–∏—Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π, –Ω–æ –Ω–µ –ø–æ–ª—É—á–µ–Ω–∏–µ

–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ:
1. –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É Chatrace
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Instagram Graph API (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –æ—Ç Meta)

