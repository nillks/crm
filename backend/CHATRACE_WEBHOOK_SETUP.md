# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –¥–ª—è Chatrace API (Instagram)

## –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**Webhook URL:** `http://localhost:3000/instagram/webhook` (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
**Webhook URL (production):** `https://your-domain.com/instagram/webhook`

## –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –≤ Chatrace

### 1. –í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Chatrace
- –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://chatrace.com
- –í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç (ID: 1543616)

### 2. –ù–∞–π–¥–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Webhook/Callback
–û–±—ã—á–Ω–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤:
- **Settings** ‚Üí **Webhooks**
- **Settings** ‚Üí **API** ‚Üí **Webhooks**
- **Settings** ‚Üí **Integrations** ‚Üí **Webhooks**
- **Account Settings** ‚Üí **Webhook URL**

### 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Webhook URL

**–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Å ngrok):**
```
https://your-ngrok-url.ngrok.io/instagram/webhook
```

**–î–ª—è production:**
```
https://your-domain.com/instagram/webhook
```

### 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ Webhook –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–∞–∫—Ç–∏–≤–µ–Ω** (enabled)
- ‚úÖ –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è: **Instagram messages** –∏–ª–∏ **Incoming messages**
- ‚úÖ –ú–µ—Ç–æ–¥: **POST**
- ‚úÖ Content-Type: **application/json**

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Webhook

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –±—ç–∫–µ–Ω–¥–∞

–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook –æ—Ç Chatrace –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:

```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üì® Received webhook from Instagram/Chatrace
üìÖ Time: 2024-11-13T12:00:00.000Z
üì¶ Body type: object
üì¶ Body keys: senderId, messageId, text, ...
üì¶ Full body: { ... }
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üîÑ Processing Chatrace webhook: { ... }
üìù Extracted data from Chatrace webhook:
  - senderId: 123456789
  - messageId: msg-123
  - text: –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
  - username: username
‚úÖ Chatrace Instagram message processed: ...
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Webhook –≤—Ä—É—á–Ω—É—é

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:

```bash
curl -X POST http://localhost:3000/instagram/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": "123456789",
    "messageId": "test-123",
    "text": "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
    "username": "test_user",
    "timestamp": 1731499200
  }'
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Chatrace

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Instagram
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞ - –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è webhook
3. –ï—Å–ª–∏ webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç:
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ webhook –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ Chatrace
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω (–¥–ª—è production)
   - –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ Chatrace:**
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–π URL: `https://domain.com/instagram/webhook`
   - –ù–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `http://localhost:3000` (—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ)

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞:**
   ```bash
   curl -X POST https://your-domain.com/instagram/webhook \
     -H "Content-Type: application/json" \
     -d '{"test": "data"}'
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞:**
   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ: `Instagram Service initialized (CHATRACE API)`
   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ polling: `Starting Instagram message polling`

### –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö:**
   - –í –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Chatrace
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `senderId` –∏ `text` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:**
   - Chatrace –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
   - –ö–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: Polling

–ï—Å–ª–∏ Chatrace –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç webhooks, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è polling:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
- –ü—Ä–æ–±—É—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ endpoints:
  - `/messages/receive`
  - `/messages/get`
  - `/instagram/messages`
  - `/api/messages`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Webhook

### –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö:

```bash
cd backend
./test-chatrace-webhook.sh
```

–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:

```bash
curl -X POST http://localhost:3000/instagram/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "senderId": "123456789",
    "messageId": "test-123",
    "text": "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
    "username": "test_user",
    "timestamp": 1731499200
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ webhook –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:

```
üì® Received webhook from Instagram/Chatrace
üì¶ Full body: { ... }
üîÑ Processing Chatrace webhook: { ... }
üìù Extracted data from Chatrace webhook:
  - senderId: 123456789
  - messageId: test-123
  - text: –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
‚úÖ Chatrace Instagram message processed: ...
```

## –í–∞–∂–Ω–æ: Chatrace –º–æ–∂–µ—Ç –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å Webhooks

**–í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:**

1. **Chatrace –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ polling** (–∫–∞–∫ Green API):
   - –ù—É–∂–Ω–æ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - –ö–æ–¥ —É–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç polling (–∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥)
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `Starting Instagram message polling`

2. **Chatrace —Ç—Ä–µ–±—É–µ—Ç –¥—Ä—É–≥—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É:**
   - –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π endpoint

3. **Chatrace –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:**
   - –í–æ–∑–º–æ–∂–Ω–æ, —Å–µ—Ä–≤–∏—Å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∫—É
   - –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å –∏–ª–∏ Instagram Graph API

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ API (—Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è):

```bash
# –ü–æ–ª—É—á–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω
TOKEN=$(curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"your@email.com","password":"yourpassword"}' \
  | jq -r '.accessToken')

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Instagram
curl -X GET http://localhost:3000/instagram/config \
  -H "Authorization: Bearer $TOKEN"
```

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Chatrace

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è:
- Email: support@chatrace.com
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: https://chatrace.com/docs (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞)
- –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç: https://chatrace.com/en/settings?acc=1543616
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞: https://chatrace.com/e

