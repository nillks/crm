# –ü—Ä–æ–≤–µ—Ä–∫–∞ Webhook Green API

## 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ backend –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook

### –í–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

Backend —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ webhook'–æ–≤. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ webhook –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üì® Received webhook from Green API
üìÖ Time: 2024-01-15T10:30:00.000Z
üì¶ Body type: object
üì¶ Body keys: typeWebhook, timestamp, data
üì¶ Full body: { ... }
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –ï—Å–ª–∏ backend –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑ npm/yarn
npm run start:dev

# –ò–ª–∏ —á–µ—Ä–µ–∑ pm2
pm2 logs backend

# –ò–ª–∏ —á–µ—Ä–µ–∑ systemd
journalctl -u crm-backend -f
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ –ª–æ–≥–∞—Ö:

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ webhook:**
   - `üì® Received webhook from Green API` - webhook –ø–æ–ª—É—á–µ–Ω
   - `üì¶ Full body: {...}` - –ø–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ webhook

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:**
   - `Extracted phone number from chatId ...` - –∏–∑–≤–ª–µ—á–µ–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
   - `Finding or creating client for phone: ...` - –ø–æ–∏—Å–∫ –∫–ª–∏–µ–Ω—Ç–∞
   - `Found existing client: ...` –∏–ª–∏ `Created new client: ...` - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞
   - `Incoming message processed: ...` - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ

3. **–û—à–∏–±–∫–∏:**
   - `‚ùå Error handling webhook:` - –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - `‚ö†Ô∏è Warning:` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

## 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ endpoint /whatsapp/stats

### –ü–æ–ª—É—á–µ–Ω–∏–µ JWT —Ç–æ–∫–µ–Ω–∞

```bash
curl -X POST http://localhost:3000/auth/login \
  -H 'Content-Type: application/json' \
  -d '{
    "email": "admin@example.com",
    "password": "your_password"
  }'
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `accessToken` –∏–∑ –æ—Ç–≤–µ—Ç–∞.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

```bash
# –ò—Å–ø–æ–ª—å–∑—É—è —Å–∫—Ä–∏–ø—Ç
chmod +x check-whatsapp-stats.sh
./check-whatsapp-stats.sh YOUR_JWT_TOKEN

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
curl -X GET http://localhost:3000/whatsapp/stats \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" | jq '.'
```

### –û—Ç–≤–µ—Ç endpoint:

```json
{
  "totalMessages": 10,
  "recentMessages": [
    {
      "id": "uuid",
      "content": "–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...",
      "clientId": "uuid",
      "clientName": "–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞",
      "clientWhatsappId": "79991234567",
      "direction": "inbound",
      "createdAt": "2024-01-15T10:30:00.000Z",
      "externalId": "message-id-from-green-api"
    }
  ],
  "clientsWithWhatsApp": 5
}
```

## 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ Green API

### –®–∞–≥–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–í–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Green API:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ https://console.green-api.com/instanceList
   - –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∏–Ω—Å—Ç–∞–Ω—Å

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook:**
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" –∏–ª–∏ "Webhook"
   - URL webhook –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å: `https://your-domain.com/whatsapp/webhook`
   - –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å ngrok: `https://your-ngrok-url.ngrok.io/whatsapp/webhook`

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:**
   - ‚úÖ `incomingMessageReceived` - –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - ‚úÖ `outgoingMessageStatus` - —Å—Ç–∞—Ç—É—Å—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∏–Ω—Å—Ç–∞–Ω—Å–∞:**
   - –ò–Ω—Å—Ç–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω"
   - –ï—Å–ª–∏ –Ω–µ—Ç - –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook –≤—Ä—É—á–Ω—É—é:

```bash
# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ webhook
curl -X POST http://localhost:3000/whatsapp/webhook \
  -H "Content-Type: application/json" \
  -d '{
    "typeWebhook": "incomingMessageReceived",
    "timestamp": 1234567890,
    "idMessage": "test-123",
    "data": {
      "typeMessage": "textMessage",
      "chatId": "79991234567@c.us",
      "senderId": "79991234567@c.us",
      "senderName": "Test User",
      "textMessage": "–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
      "idMessage": "test-123",
      "timestamp": 1234567890
    }
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ª–æ–≥–∞—Ö:

–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ webhook –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend - –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏ –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ webhook.

## 4. –û—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WhatsApp –∏–∑ –ë–î

```bash
# –ò—Å–ø–æ–ª—å–∑—É—è —Å–∫—Ä–∏–ø—Ç
npx ts-node backend/clear-whatsapp-messages.ts

# –ò–ª–∏ —á–µ—Ä–µ–∑ SQL –Ω–∞–ø—Ä—è–º—É—é
psql -U postgres -d crm_db -c "DELETE FROM messages WHERE channel = 'whatsapp';"
```

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ backend –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ Green API
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend - –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏ –æ –ø–æ–∏—Å–∫–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint `/whatsapp/stats` - –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –ë–î
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `whatsappId` –∫–ª–∏–µ–Ω—Ç–∞

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–Ω–æ –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `whatsappId` –∫–ª–∏–µ–Ω—Ç–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–æ–º–µ—Ä–æ–º –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ (–∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç—Å—è –≤ –Ω–µ–º)
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–±–µ–∑ + –∏ –ø—Ä–æ–±–µ–ª–æ–≤)

